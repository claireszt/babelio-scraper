name: Run Scraper Daily

on:
  schedule:
    - cron: "0 0 * * 1"
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest

    env:
      BABELIO_EMAIL: ${{ secrets.BABELIO_EMAIL }}
      BABELIO_PASSWORD: ${{ secrets.BABELIO_PASSWORD }}
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
      RELATED_BOOKS_PAGE_ID: ${{ secrets.RELATED_BOOKS_PAGE_ID }}

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üñ•Ô∏è Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üåç Install Chrome for Puppeteer
        run: |
          sudo apt update
          sudo apt install -y wget curl
          sudo apt install -y google-chrome-stable

      - name: üì¶ Install dependencies
        run: npm install

      - name: üõ†Ô∏è Debug Environment Variables
        run: |
          echo "üîç Checking environment variables..."

          for VAR in BABELIO_EMAIL BABELIO_PASSWORD GH_TOKEN NOTION_DATABASE_ID NOTION_TOKEN RELATED_BOOKS_PAGE_ID
          do
            if [[ -z "${!VAR}" ]]; then
              echo "‚ùå ERROR: $VAR is missing!"
            else
              echo "‚úÖ $VAR is set"
            fi
          done

      - name: üåê Sanity check network
        run: |
          set -euxo pipefail
          echo "Checking connectivity to login URL..."
          curl -I --location --max-time 20 "$LOGIN_URL"
        env:
          LOGIN_URL: "https://www.babelio.com/connection.php"

      - name: üì° Run Scraper
        run: |
          set -e 
          node index.js

      - name: ‚úÖ Commit & Push updated files
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'actions@github.com'
          git add books.json  
          git commit -m "Updated books.json" || exit 0
          git push https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/claireszt/babelio-scrapper.git main
